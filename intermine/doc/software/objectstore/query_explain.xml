<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD Simplified DocBook XML V1.0//EN"
"http://www.oasis-open.org/docbook/xml/simple/1.0/sdocbook.dtd">
<article>
  <articleinfo>
    <date>2003-03-12</date>

    <title>Running Explain for InterMine Queries</title>

    <authorgroup>
      <author>
        <firstname>Richard</firstname>

        <surname>Smith</surname>
      </author>

      <author>
        <firstname>Matthew</firstname>

        <surname>Wakeling</surname>
      </author>
    </authorgroup>
  </articleinfo>

  <section>
    <title>Overview</title>

    <para>This document summarises our discussion about the role of EXPLAIN in
    running InterMine queries and how it should be implemented. The purpose of
    running EXPLAIN is to obtain estimated information about the time to run a
    query and the number of rows it will return allowing us to limit what is
    run in the database. We also want to make estimated (and/or computed)
    statistics about a query available to client applications prior to
    execution.</para>
  </section>

  <section>
    <title>Information available from EXPLAIN</title>

    <para>EXPLAIN displays the execution plan that the planner produces for a
    given SQL statement. The plan details how tables will be scanned and what
    join strategies will be used. In addition some estimated statistics are
    produced for the query:</para>

    <itemizedlist>
      <listitem>
        <para>The estimated cost of running a query in terms of disk page
        fetches, two figures are displayed:</para>

        <itemizedlist>
          <listitem>
            <para>estimated time for the first row to be returned</para>
          </listitem>

          <listitem>
            <para>estimated time for completion of entire query</para>
          </listitem>
        </itemizedlist>
      </listitem>

      <listitem>
        <para>An estimated number of rows that the query will return, based on
        estimated selectivity of where clauses.</para>
      </listitem>

      <listitem>
        <para>The average width (bytes) of rows produced by the query</para>
      </listitem>
    </itemizedlist>
  </section>

  <section>
    <title>When we need to run EXPLAIN</title>

    <para>Our purpose in running EXPLAIN for all queries is twofold:</para>

    <itemizedlist>
      <listitem>
        <para>to provide users with an estimated number of rows a given query
        will produce.</para>
      </listitem>

      <listitem>
        <para>to prevent queries that would take more than a threshold amount
        of time from being run in the database.</para>
      </listitem>
    </itemizedlist>

    <para>Our implementation of paging dictates that these are two distinct
    operations. When a query is run the <literal>Results</literal> object
    defines a LIMIT and OFFSET to restrict the number of rows returned at one
    time (e.g the first 1000). It is when when this limited query is run that
    we need to restrict the amount of time it can take. To estimate the total
    number of rows a query will return we obviously need to EXPLAIN it without
    a LIMIT.</para>

    <para>Thus, we need to run EXPLAIN on the original query and on each
    'page' with OFFSET and LIMIT defined. This is done as follows:</para>

    <itemizedlist>
      <listitem>
        <para><literal>ObjectStore.estimate(query)</literal> method that,
        given a query, will return a ResultsInfo object containing information
        about the estimated number of rows and time to run. The Results object
        has a similar method (<literal>getInfo()</literal>) which will include
        information such as any knowledge the Results object has on the number
        of rows. This is called as required by the client application and is
        not necessary for normal query execution.</para>
      </listitem>

      <listitem>
        <para><literal>ObjectStoreInterMineImpl.execute(query, start,
        limit)</literal> performs an explain on the batch to be fetched, and
        decides if the query is faster or slower that the given threshold. If
        the query is too slow an Exception is thrown, otherwise the query runs
        as normal. The threshold is provided in the properties file, so that
        users could set their own maximum execution time (such that it is less
        than our global threshold).</para>
      </listitem>
    </itemizedlist>
  </section>
</article>