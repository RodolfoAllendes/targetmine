<project name="intermine-www" default="www-intermine" basedir=".">
    <property name="build.properties.local" value="${user.home}/build.properties.${ant.project.name}" />

    <property file="${build.properties.local}"/>
    <property name="src.www" location="site"/>
    <property name="src.doc" location="../../intermine/doc"/>
    <property name="build.www" location="build"/>
    <property name="dist.www" location="dist"/>

  <property name="runtime.properties.local" value="${user.home}/${ant.project.name}.properties" />

<target name="prepare">
    <copy todir="${build.www}">
        <fileset dir="${src.www}">
            <include name="**/*"/>
        </fileset>
    </copy>

    <copy todir="${build.www}/doc">
        <fileset dir="${src.doc}">
            <include name="**/*"/>
        </fileset>
    </copy>

    <copy todir="${dist.www}/style/">
        <fileset dir="${build.www}/style/">
           <include name="*"/>
        </fileset>
    </copy>

    <copy todir="${dist.www}/doc/">
        <fileset dir="${build.www}/doc/">
            <include name="**/*.pdf"/>
            <include name="**/*.sxi"/>
            <include name="**/*.png"/>
            <include name="**/*.gif"/>
            <include name="**/*.zargo"/>
        </fileset>
     </copy>

</target>

<target name="www-intermine" depends="prepare"> 
    <style basedir="${build.www}" destdir="${dist.www}" extension=".html"
        style="../main.xsl" includes="**/*.xml" force="false">
        <param name="branding" expression="intermine" />
        <param name="basedir" expression="${www.location}" />
        <param name="outputext" expression="html" />
        <param name="file" expression="systemId()" />
        <param name="sourceref" expression="${build.www}" />
        <factory>
            <attribute name="http://xml.apache.org/xalan/properties/source-location" value="true"/>
        </factory>
    </style>
</target>

<target name="release-www" depends="www-intermine"
    description="releases the static website to the webserver">
    <chmod perm="a+r" type="file">
      <fileset dir="${dist.www}">
        <include name="**/**" />
      </fileset>
    </chmod>
    <chmod perm="a+rx" type="dir">
      <fileset dir="${dist.www}">
        <include name="**/**" />
      </fileset>
    </chmod>
    <exec executable="rsync">
      <arg line="-e ssh -Cavz --exclude api --delete ${dist.www}/ ${www.serverlocation}/" />
    </exec>
</target>

<target name="clean">
    <delete dir="${build.www}"/>
    <delete dir="${dist.www}"/>
</target>

<target name="release-demo-webapp">
  <ant dir="../../intermine-www" target="distclean" inheritRefs="true"/>
  <ant dir="../../intermine-www" target="jar" inheritRefs="true"/>
  <ant dir="../../intermine-www" target="build-testmodel-webapp" inheritRefs="true"/>

  <path id="demo.class.path">
    <fileset dir="../../intermine-www/dist" includes="*.jar"/>
    <pathelement path="../../intermine-www/resources/test"/>
  </path>

  <property name="build.model" location="../../intermine-www/build/model" />
  <ant dir="../../intermine-www" antfile="build-model.xml" target="build-db" inheritRefs="true">
      <property name="model.name" value="testmodel"/>
      <reference torefid="class.path" refid="demo.class.path"/>
      <property name="db.name" value="db.demo"/>
  </ant>

  <taskdef
      name="insert-xml-data"
      classname="org.intermine.dataloader.XmlDataLoaderTask">
      <classpath refid="demo.class.path"/>
  </taskdef>
  <insert-xml-data integrationWriter="integration.demo" xmlFile="../../intermine-www/resources/test/testmodel_data.xml" sourceName="testsource">
    <classpath refid="demo.class.path"/>
  </insert-xml-data>

  <ant dir="../../intermine-www" target="release-webapp" inheritRefs="true"/>
</target>

</project>
