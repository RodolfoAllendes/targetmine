
<project name="application" default="default" basedir="."
         xmlns:appl="http://www.intermine.org/ns/im-appl-proj/1"
         xmlns:task="http://www.intermine.org/ns/im-task-proj/1">

  <dirname property="application.xml.basedir" file="${ant.file.application}"/>
  <import file="${application.xml.basedir}/webapp.xml"/>
  <import file="${application.xml.basedir}/task.xml"/>

  <!-- Local webapp build/deploy properties -->
  <property name="build.properties.local" value="${user.home}/build.properties.${ant.project.name}" />
  <property file="${build.properties.local}"/>

  <!-- INIT -->

  <target name="-pre-init" depends="webapp.-pre-init">
    <!-- Any generated files WEB-INF files should be placed in this directory -->
    <property name="build.webinf.dir" location="${build.dir}/web-inf"/>
    <!-- Files -->
    <property name="default.template.queries" location="${src.dir}/default-template-queries.xml"/>
    <!-- Location of model-less intermine-webapp.war -->
    <property name="source.intermine.webapp.war" location="${application.xml.basedir}/../intermine/webapp/main/dist/intermine-webapp.war"/>
  </target>

  <!-- WAR INSTEAD OF JAR -->

  <target name="-pre-jar" depends="webapp.-pre-jar">
    <!-- Start with base intermine webapp war -->
    <copy file="${source.intermine.webapp.war}" tofile="${main.dist.war}"/>
    <!-- Concatenate local build.properties with web.properties -->
    <mkdir dir="${build.webinf.dir}"/>
    <copy tofile="${build.webinf.dir}/web.properties.tmp"
          file="${resources.dir}/web.properties"
          overwrite="true" verbose="true"/>
    <concat destfile="${build.webinf.dir}/web.properties">
      <fileset file="${build.webinf.dir}/web.properties.tmp"/>
      <fileset file="${build.properties.local}"/>
    </concat>
    <delete file="${build.webinf.dir}/web.properties.tmp"/>
    <!-- Copy intermine.properties into build/classes -->
    <copy file="${user.home}/${intermine.properties.file}"
          tofile="${main.build.classes.dir}/intermine.properties"/>
    <!-- Copy default.intermine.properties into build/classes -->
    <copy file="${default.intermine.properties.file}"
          tofile="${main.build.classes.dir}/default.intermine.properties"/>
  </target>

  <target name="do-jar" depends="-init-presetdef-war">
    <appl:war/>
  </target>

  <!-- USER PROFILE -->

  <target name="-init-build-db" depends="init, -init-deps-no-build, -init-task-xml">
    <!-- Copy intermine.properties onto the task classpath -->
    <copy file="${user.home}/${intermine.properties.file}"
          tofile="${build.task.dir}/intermine.properties"/>
    <!-- Copy default.intermine.properties into build/classes -->
    <copy file="${default.intermine.properties.file}"
          tofile="${build.task.dir}/default.intermine.properties"/>
  </target>
  
  <target name="build-db-userprofile" depends="-do-build-db-userprofile, load-default-templates"/>
  
  <target name="-do-build-db-userprofile" depends="-init-build-db">
    <task:build-db osname="${userprofile.objectstore.name}"
                       dbname="${userprofile.db.name}"
                       model="${userprofile.model.name}"/>
  </target>
  
  <target name="load-default-templates" depends="-init-build-db">
    <load-default-templates templatesXml="${default.template.queries}"
                            username="${superuser.account}" osAlias="${objectstore.name}"
                            userProfileAlias="${userprofile.objectstorewriter.name}"/>
  </target>

  <target name="write-userprofile-xml" depends="-init-build-db">
    <write-userprofile-xml fileName="${build.dir}/userprofile.xml" osAlias="${objectstore.name}"
                           userProfileAlias="${userprofile.objectstorewriter.name}"/>
  </target>

  <target name="read-userprofile-xml" depends="-init-build-db">
    <read-userprofile-xml fileName="${build.dir}/userprofile.xml" osAlias="${objectstore.name}"
                          userProfileAlias="${userprofile.objectstorewriter.name}"/>
  </target>

  <!-- PRECOMPUTING -->

  <target name="drop-precomputed-tables" depends="-init-build-db">
    <drop-precomputed-tables alias="${objectstore.name}"/>
  </target>

  <target name="precompute-queries" depends="-init-build-db">
    <precompute-queries alias="${objectstore.name}"
                        summaryPropertiesFile="objectstoresummary.properties"
                        minRows="0"/>
  </target>

  <target name="precompute-queries-test" depends="-init-build-db">
    <precompute-queries alias="${objectstore.name}" testMode="true"
                        summaryPropertiesFile="objectstoresummary.properties"
                        minRows="0"/>
  </target>

  <target name="precompute-templates" depends="-init-build-db">
    <precompute-templates alias="${objectstore.name}" minRows="0"
                          templatesFile="${default.template.queries}"/>
  </target>

  <!-- MACRO DEFINITIONS -->

  <target name="-init-presetdef-war">
    <macrodef name="war" uri="http://www.intermine.org/ns/im-appl-proj/1">
      <sequential>
        <war compress="${jar.compress}" destfile="${main.dist.war}" update="true">
          <classes dir="${main.build.classes.dir}"/>
          <lib dir="${web.lib.dir}"/>
          <webinf dir="${webinf.dir}" excludes="web.xml"/>
          <webinf dir="${build.webinf.dir}"/>
          <fileset dir="${main.resources.dir}"/>
        </war>
      </sequential>
    </macrodef>
  </target>

</project>
