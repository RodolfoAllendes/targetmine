
<project name="webapp" default="default" basedir="." xmlns:webapp="http://www.intermine.org/ns/im-webapp-proj/1">

  <dirname property="webapp.xml.basedir" file="${ant.file.webapp}"/>
  
  <import file="${webapp.xml.basedir}/library.xml"/>
  
  <target name="-pre-pre-init" depends="library.-pre-pre-init">
    <property name="resources.dir" location="resources/main"/>
  </target>
  
  <target name="-pre-init" depends="library.-pre-init">
    <property name="dist.war" location="${dist.dir}/${ant.project.name}.war"/>
    <property name="webinf.dir" location="resources/web-inf"/>
    <property name="web.xml" location="${webinf.dir}/web.xml"/>
    <property name="web.lib.dir" location="${build.dir}/lib"/>
    <!-- Any generated files WEB-INF files should be placed in this directory -->
    <property name="build.webinf.dir" location="${build.dir}/web-inf"/>
    <!-- War settings -->
    <property name="war.update" value="false"/>
    <property name="deploy.excludes" value=""/>
  </target>
  
  <!-- WAR INSTEAD OF JAR -->
  
  <target name="-pre-jar">
    <dependencies basedir="${library.xml.basedir}/.." buildDependencies="false"
                  type="deploy" noFollow="true"/>
    <!-- copy all dependencies into build/lib -->
    <mkdir dir="${web.lib.dir}"/>
    <mkdir dir="${build.webinf.dir}"/>
    <copy todir="${web.lib.dir}" flatten="true">
      <fileset refid="deploy.execute.path.fileset"/>
    </copy>
  </target>
  
  <target name="do-jar" depends="-init-presetdef-war">
    <webapp:war/>
  </target>
  
  <!-- RELEASE / REMOVE FROM TOMCAT -->
  
  <target name="release-webapp" depends="init">
    <taskdef name="tomcat-deploy" classname="org.apache.catalina.ant.DeployTask"
             classpath="${webapp.xml.basedir}/lib/catalina-ant.jar"/>
    <tomcat-deploy url="${webapp.deploy.url}/manager"
                   username="${webapp.manager}" 
                   password="${webapp.password}"
                   path="/${webapp.path}" 
                   war="file://${dist.war}"/>
  </target>

  <target name="remove-webapp" depends="init">
    <taskdef name="tomcat-undeploy" classname="org.apache.catalina.ant.UndeployTask"
             classpath="${webapp.xml.basedir}/lib/catalina-ant.jar"/>
    <tomcat-undeploy url="${webapp.deploy.url}/manager"
                     username="${webapp.manager}" 
                     password="${webapp.password}"
                     path="/${webapp.path}"/>
  </target>
  
  <!-- MACRO DEFINITIONS -->
  
  <target name="-init-presetdef-war">
    <macrodef name="war" uri="http://www.intermine.org/ns/im-webapp-proj/1">
      <sequential>
        <war compress="${jar.compress}" warfile="${dist.war}" webxml="${web.xml}">
          <classes dir="${build.classes.dir}"/>
          <lib dir="${web.lib.dir}" excludes="${deploy.excludes}"/>
          <webinf dir="${webinf.dir}" excludes="web.xml"/>
          <webinf dir="${build.webinf.dir}"/>
          <fileset dir="${resources.dir}"/>
        </war>
      </sequential>
    </macrodef>
  </target>
  
</project>
