
<project name="objectstore" default="default" basedir="."
    xmlns:os="http://www.intermine.org/ns/im-os-proj/1"
    xmlns:task="http://www.intermine.org/ns/im-db-proj/1">

  <dirname property="objectstore.xml.basedir" file="${ant.file.objectstore}"/>
  
  <import file="${objectstore.xml.basedir}/model.xml"/>
  
  <!-- Our generate phase involves fetching the model from the database. -->
  <property name="generating.code" value="true"/>
  
  <!-- INIT TASKS -->
  
  <target name="-pre-init" depends="model.-pre-init">
    <property name="build.model.dir" location="${build.dir}/model"/>
    <property name="objectstore.summary.properties" location="${main.build.classes.dir}/objectstoresummary.properties"/>
  </target>
  
  <!-- BUILD DB -->
  
  <target name="-init-build-db" depends="init, -init-deps, -init-task-xml">
    <!-- Make directories -->
    <mkdir dir="${build.model.dir}"/>
    <!-- Copy intermine.properties onto the classpath -->
    <copy file="${user.home}/${intermine.properties.file}" 
          tofile="${build.task.dir}/intermine.properties"/>
    <!-- Copy default.intermine.properties onto the classpath -->
    <copy file="${default.intermine.properties.file}" 
          tofile="${build.task.dir}/default.intermine.properties"/>
  </target>
  
  <target name="-pre-build-db"/>
  
  <target name="-post-build-db"/>
  
  <target name="-do-build-db">
    <task:build-db osname="${objectstore.name}" dbname="${db.name}" model="${model.name}"/>
  </target>
  
  <target name="build-db" depends="-init-build-db, -pre-build-db, -do-build-db, -post-build-db"/>
  
  <!-- GENERATE (FETCH) -->
  
  <target name="-init-generate" depends="model.-init-generate">
    <!-- We actually get the model xml quite late (from the database) so we set this now -->
    <condition property="have.xml">
      <and><istrue value="true"/></and>
    </condition>
  </target>
  
  <target name="-pre-generate" depends="-init-task-xml">
    <!-- Retrieve model from database -->
    <retrieve-metadata database="${db.name}" destDir="${build.model.dir}"/>
    <!-- Summarise objectstore -->
    <echo message="Summarising object store ${objectstore.name}..."/>
    <summarise-objectstore alias="${objectstore.name}"
                           outputFile="${objectstore.summary.properties}"
                           inputFile="objectstoresummary.config.properties"/>
    <!-- Copy retrieved files so that model generation and packaging tasks will find them -->
    <copy file="${build.model.dir}/${model.name}_model.xml"
          tofile="${model.name}_model.xml"
          preservelastmodified="true"/>
    <mkdir dir="${main.build.classes.dir}"/>
    <copy file="${build.model.dir}/${model.name}_keyDefs.properties"
          todir="${main.build.classes.dir}"/>
  </target>
  
  <target name="-post-generate">
    <delete file="${model.name}_model.xml"/>
  </target>
    
</project>
